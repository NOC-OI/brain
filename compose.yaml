services:
  nginx:
    image: nginx:1.25.4
    container_name: brain-nginx
    depends_on:
      - dashboard
    env_file:
      - ./.env
    attach: false
    ports:
      - ${MANAGEMENT_EXTERNAL_PORT}:80
    networks:
      - private
    volumes:
      - ./templates/nginx.conf:/etc/nginx/conf.d/revproxy.conf

  dashboard:
    image: brain/dashboard
    container_name: brain-dashboard
    depends_on:
      - rabbitmq
    entrypoint: ["gunicorn", "-w", "${GUNICORN_WORKERS}", "main:app", "-b", "0.0.0.0:8080"]
    env_file:
      - ./.env
    volumes:
      - ./config.json:/app/config.json
      - /var/brain:/var/brain
    extra_hosts:
      - host.docker.internal:host-gateway
    networks:
      - private

  vision:
    image: brain/vision
    container_name: brain-vision
    depends_on:
      - rabbitmq
    runtime: nvidia
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    env_file:
      - ./.env
    extra_hosts:
      - host.docker.internal:host-gateway
    networks:
      - private

  asea2-camera-if:
    image: brain/asea2-camera-if:0.0
    container_name: brain-asea2-camera-if
    depends_on:
      - rabbitmq
    volumes:
      - /mnt:/mnt
    env_file:
      - ./.env
    extra_hosts:
      - host.docker.internal:host-gateway
    networks:
      - private

  rabbitmq:
    image: rabbitmq:3-management
    container_name: brain-rabbitmq
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 30s
      timeout: 30s
      retries: 3
    attach: false
    ports:
      - 5672:5672
    env_file:
      - ./.env
    command: ["bash", "-c", "chmod 400 /var/lib/rabbitmq/.erlang.cookie; rabbitmq-server"]
    networks:
      - private
    
networks:
  private:
    external: false



